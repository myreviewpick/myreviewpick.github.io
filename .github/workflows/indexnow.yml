name: IndexNow Submission

on:
  push:
    branches: [ master ]
    paths:
      - '_posts/**'
  workflow_dispatch:

jobs:
  submit-indexnow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Get changed posts
        id: changed-files
        run: |
          # ë³€ê²½ëœ _posts íŒŒì¼ ì°¾ê¸°
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '^_posts/' | grep '\.md$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "ë³€ê²½ëœ í¬ìŠ¤íŠ¸ ì—†ìŒ"
            echo "urls=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # URL ëª©ë¡ ìƒì„±
          URLS=""
          for file in $CHANGED_FILES; do
            # íŒŒì¼ëª…ì—ì„œ ë‚ ì§œì™€ ì œëª© ì¶”ì¶œ
            filename=$(basename "$file" .md)
            # YYYY-MM-DD-title.md í˜•ì‹
            if [[ $filename =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}-(.+)$ ]]; then
              title="${BASH_REMATCH[1]}"
              url="https://shopping42.github.io/posts/${title}/"
              URLS="${URLS}${url}\n"
            fi
          done
          
          echo "urls<<EOF" >> $GITHUB_OUTPUT
          echo -e "$URLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ğŸ”— ì œì¶œí•  URL:"
          echo -e "$URLS"
      
      - name: Submit to Bing IndexNow
        if: steps.changed-files.outputs.urls != ''
        run: |
          URLS="${{ steps.changed-files.outputs.urls }}"
          
          for url in $URLS; do
            if [ -n "$url" ]; then
              echo "ğŸ“¤ Bing IndexNow ì œì¶œ: $url"
              
              curl -X POST "https://api.indexnow.org/indexnow" \
                -H "Content-Type: application/json" \
                -d "{
                  \"host\": \"shopping42.github.io\",
                  \"key\": \"${{ secrets.INDEXNOW_KEY }}\",
                  \"keyLocation\": \"https://shopping42.github.io/${{ secrets.INDEXNOW_KEY }}.txt\",
                  \"urlList\": [\"$url\"]
                }" || echo "âš ï¸ ì œì¶œ ì‹¤íŒ¨ (ì •ìƒì ì¼ ìˆ˜ ìˆìŒ)"
              
              sleep 2
            fi
          done
      
      - name: Submit to Naver IndexNow
        if: steps.changed-files.outputs.urls != ''
        run: |
          URLS="${{ steps.changed-files.outputs.urls }}"
          
          for url in $URLS; do
            if [ -n "$url" ]; then
              echo "ğŸ“¤ Naver IndexNow ì œì¶œ: $url"
              
              curl -X POST "https://searchadvisor.naver.com/indexnow" \
                -H "Content-Type: application/json" \
                -d "{
                  \"host\": \"shopping42.github.io\",
                  \"key\": \"${{ secrets.INDEXNOW_KEY }}\",
                  \"keyLocation\": \"https://shopping42.github.io/${{ secrets.INDEXNOW_KEY }}.txt\",
                  \"urlList\": [\"$url\"]
                }" || echo "âš ï¸ ì œì¶œ ì‹¤íŒ¨ (ì •ìƒì ì¼ ìˆ˜ ìˆìŒ)"
              
              sleep 2
            fi
          done
      
      - name: Submit to Yandex IndexNow
        if: steps.changed-files.outputs.urls != ''
        run: |
          URLS="${{ steps.changed-files.outputs.urls }}"
          
          for url in $URLS; do
            if [ -n "$url" ]; then
              echo "ğŸ“¤ Yandex IndexNow ì œì¶œ: $url"
              
              curl -X POST "https://yandex.com/indexnow" \
                -H "Content-Type: application/json" \
                -d "{
                  \"host\": \"shopping42.github.io\",
                  \"key\": \"${{ secrets.INDEXNOW_KEY }}\",
                  \"keyLocation\": \"https://shopping42.github.io/${{ secrets.INDEXNOW_KEY }}.txt\",
                  \"urlList\": [\"$url\"]
                }" || echo "âš ï¸ ì œì¶œ ì‹¤íŒ¨ (ì •ìƒì ì¼ ìˆ˜ ìˆìŒ)"
              
              sleep 2
            fi
          done
      
      - name: Summary
        if: steps.changed-files.outputs.urls != ''
        run: |
          echo "âœ… IndexNow ì œì¶œ ì™„ë£Œ"
          echo "ì œì¶œëœ URL:"
          echo "${{ steps.changed-files.outputs.urls }}"
